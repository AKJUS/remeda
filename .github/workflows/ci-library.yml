name: ğŸ“¦ CI - Library

on:
  push:
    branches:
      - main
  pull_request:
  # For debugging workflows or for re-triggering releases if they failed on
  # network issues or problems at external 3rd party services (npm, jsr,
  # etc...).
  workflow_dispatch:

permissions: {}

env:
  # @see https://typicode.github.io/husky/how-to.html#ci-server-and-docker
  HUSKY: 0

jobs:
  typecheck:
    name: ğŸ‘· Typecheck
    runs-on: ubuntu-latest
    permissions:
      # Reports its findings as review comments on the PR
      pull-requests: write
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .nvmrc

      - name: ğŸ“¥ Download dependencies
        uses: bahmutov/npm-install@3e063b974f0d209807684aa23e534b3dde517fd9 # v1.11.2

      - name: ğŸš¨ Type check
        run: npm --workspace=remeda run check

  build:
    name: ğŸ—ï¸ Build
    needs:
      - typecheck
    runs-on: ubuntu-latest
    outputs:
      distCacheKey: ${{ steps.hash-dist.outputs.distCacheKey }}
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .nvmrc

      - name: ğŸ“¥ Download dependencies
        uses: bahmutov/npm-install@3e063b974f0d209807684aa23e534b3dde517fd9 # v1.11.2

      # Generate the cache key so we can reuse it in the next job.
      - name: ğŸ”‘ Hash distributable
        id: hash-dist
        # For the best results this should be kept in sync with the key used by
        # the same job in the `canaries` workflow, that way we can reuse the
        # cache across workflows.
        run: echo "distCacheKey=dist-${{ hashFiles('package-lock.json', 'packages/remeda/src/**/*.ts', 'packages/remeda/tsdown.config.ts') }}" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ Build
        run: npm --workspace=remeda run build

      - name: ğŸšš Save distributable
        uses: actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: packages/remeda/dist
          key: ${{ steps.hash-dist.outputs.distCacheKey }}

  test-types:
    name: Tests/ğŸ“‹ Types [TypeScript ${{ matrix.typescript-version }}]
    needs:
      - build
    runs-on: ubuntu-latest
    permissions:
      # Reports its findings as review comments on the PR
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        typescript-version:
          - "5.9"
          - "5.8"
          - "5.7"
          - "5.6"
          - "5.5"
          - "5.4"
          - "5.3"
          - "5.2"
          # This is the current lowest version of typescript we support. Do not
          # change this without bumping a major version. We support up to 4
          # versions back from the latest version of typescript at time of a
          # major release.
          - "5.1"

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .nvmrc

      - name: ğŸ“¥ Download dependencies
        uses: bahmutov/npm-install@3e063b974f0d209807684aa23e534b3dde517fd9 # v1.11.2

      - name: ğŸ“˜ Install TypeScript
        run: npm --workspace=remeda install -D typescript@${{ matrix.typescript-version }}

      - name: ğŸ“‹ Run type tests
        run: npm --workspace=remeda run test:types

      # We restore the distributable and check it last so that we don't do
      # redundant work if the type tests already failed (which is way more
      # common than the build typing failing).
      - name: ğŸšš Restore distributable
        uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: packages/remeda/dist
          fail-on-cache-miss: true
          key: ${{ needs.build.outputs.distCacheKey }}

      - name: ğŸ§ Check distributable
        run: npm --workspace=remeda run check:dist

  test-runtime:
    name: Tests/ğŸ§ª Runtime [Node ${{ matrix.node }}]
    needs:
      - typecheck
    runs-on: ubuntu-latest
    permissions:
      # Reports its findings as review comments on the PR
      pull-requests: write
    strategy:
      matrix:
        node:
          - 25
          - 24
          - 22
          - 20
          - 18
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ matrix.node }}

      - name: ğŸ“¥ Download dependencies
        uses: bahmutov/npm-install@3e063b974f0d209807684aa23e534b3dde517fd9 # v1.11.2

      - name: ğŸ§ª Run tests
        run: npm --workspace=remeda run test:runtime

  test-prop:
    name: Tests/ğŸ² Property
    needs:
      - test-runtime
    runs-on: ubuntu-latest
    permissions:
      # Reports its findings as review comments on the PR
      pull-requests: write
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .nvmrc

      - name: ğŸ“¥ Download dependencies
        uses: bahmutov/npm-install@3e063b974f0d209807684aa23e534b3dde517fd9 # v1.11.2

      - name: ğŸ² Run property tests
        run: npm --workspace=remeda run test:prop -- --run

  lint:
    name: ğŸ§¹ Lint
    needs:
      - typecheck
    runs-on: ubuntu-latest
    permissions:
      # Reports its findings as review comments on the PR
      pull-requests: write
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .nvmrc

      - name: ğŸ“¥ Download dependencies
        uses: bahmutov/npm-install@3e063b974f0d209807684aa23e534b3dde517fd9 # v1.11.2

      - name: ğŸ§¹ Lint
        run: npm --workspace=remeda run lint

  format:
    name: ğŸ’„ Format
    needs:
      - typecheck
    runs-on: ubuntu-latest
    permissions:
      # Reports its findings as review comments on the PR
      pull-requests: write
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .nvmrc

      - name: ğŸ“¥ Download dependencies
        uses: bahmutov/npm-install@3e063b974f0d209807684aa23e534b3dde517fd9 # v1.11.2

      - name: ğŸ’„ Format
        run: npm --workspace=remeda run format

  slow-types:
    name: ğŸ¢ Slow types
    needs:
      - typecheck
    runs-on: ubuntu-latest
    permissions:
      # Reports its findings as review comments on the PR
      pull-requests: write
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .nvmrc

      - name: ğŸ“¥ Download dependencies
        uses: bahmutov/npm-install@3e063b974f0d209807684aa23e534b3dde517fd9 # v1.11.2

      - name: ğŸ¢ Slow types
        run: npm --workspace=remeda run publish:jsr -- --dry-run --set-version 0.0.0

  preview:
    name: ğŸ§‘â€ğŸ”¬ Preview
    needs:
      - build
    runs-on: ubuntu-latest
    permissions:
      # Provides a link to the preview as a comment in the PR
      pull-requests: write
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .nvmrc

      - name: ğŸ“¥ Download dependencies
        uses: bahmutov/npm-install@3e063b974f0d209807684aa23e534b3dde517fd9 # v1.11.2

      - name: ğŸšš Restore distributable
        uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: packages/remeda/dist
          fail-on-cache-miss: true
          key: ${{ needs.build.outputs.distCacheKey }}

      - name: ğŸ§‘â€ğŸ”¬ Preview
        run: npm --workspace=remeda run publish:preview

  release:
    name: ğŸš€ Release
    needs:
      - test-types
      - test-runtime
      - test-prop
      - lint
      - format
      - slow-types
    if: github.repository == 'remeda/remeda' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.released.outputs.version }}
    permissions:
      # @see https://semantic-release.gitbook.io/semantic-release/recipes/ci-configurations/github-actions#github-workflows-release.yml-configuration-for-node-projects
      # to be able to publish a GitHub release
      contents: write
      # to enable use of OIDC for npm provenance
      id-token: write
      # to be able to comment on released issues
      issues: write
      # to be able to comment on released pull requests
      pull-requests: write
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .nvmrc

      - name: ğŸ“¥ Download dependencies
        uses: bahmutov/npm-install@3e063b974f0d209807684aa23e534b3dde517fd9 # v1.11.2

      - name: ğŸ” Audit supply chain
        run: npm --workspace=remeda audit signatures

      - name: ğŸ—ï¸ Build
        run: npm --workspace=remeda run build

      - name: ğŸš€ Release
        run: npx --workspace=remeda --no semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Get released version
        id: released
        # We rely on semantic-release tagging the commits with the pattern:
        # `v<major>.<minor>.<patch>` (notice the leading `v`!).
        run: |
          echo "version=$(
            git describe --exact-match --tags HEAD 2>/dev/null \
            | grep --only-matching --perl-regexp "\B(\d+\.){2}\d+$" \
            || true
          )" >> "$GITHUB_OUTPUT"

      - name: ğŸ“¤ Upload tarball
        if: steps.released.outputs.version != ''
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: tarball
          # Keep in sync with the location of the generated tarball configured
          # in `release.config.js`. We also on `npm` naming the file:
          # `remeda-<version>.tgz`.
          path: packages/remeda/remeda-*.tgz
          if-no-files-found: error
          overwrite: true
          retention-days: 7

  sign-release:
    name: ğŸ” Sign release
    needs:
      - release
    if: needs.release.outputs.version != ''
    runs-on: ubuntu-latest
    permissions:
      # to create SLSA provenance attestations
      attestations: write
      # to upload assets to the GitHub release
      contents: write
      # to enable OIDC for cosign keyless signing
      id-token: write
    steps:
      - name: ğŸ“¥ Download tarball
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: tarball

      - name: ğŸ”§ Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: ğŸ” Sign tarball
        # We assume the file created by semantic-release follows the pattern
        # `remeda-<version>.tgz`. If the package name changes this will break.
        run: cosign sign-blob --yes --bundle="remeda-${{ needs.release.outputs.version }}.tgz.sigstore.json" "remeda-${{ needs.release.outputs.version }}.tgz"

      - name: ğŸ“œ Attest tarball provenance
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-path: remeda-${{ needs.release.outputs.version }}.tgz

      - name: ğŸ“¤ Upload signed artifacts to release
        run: gh release upload --clobber "v${{ needs.release.outputs.version }}" "remeda-${{ needs.release.outputs.version }}.tgz" "remeda-${{ needs.release.outputs.version }}.tgz.sigstore.json"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-jsr:
    name: ğŸ¦• Publish to JSR.io
    needs:
      - release
    if: needs.release.outputs.version != ''
    runs-on: ubuntu-latest
    permissions:
      # OIDC for JSR publishing
      id-token: write
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .nvmrc

      - name: ğŸ“¥ Download dependencies
        uses: bahmutov/npm-install@3e063b974f0d209807684aa23e534b3dde517fd9 # v1.11.2

      - name: ğŸ¦• Publish to JSR.io
        run: npm --workspace=remeda run publish:jsr -- --set-version "${{ needs.release.outputs.version }}"
